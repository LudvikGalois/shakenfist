#########################################
# Scenario: requesting a specific IP address should work
#########################################

- hosts: sf-1
  any_errors_fatal: true
  become: yes
  become_method: sudo
  gather_facts: no
  connection: ssh

  tasks:
    - include: _util_network_create.yml
        netblock="192.168.242.0/24"
        name="net_four"

    - include: _util_instance_start.yml
        name="cirros_net_four"
        distro=cirros
        network="{{net_four_uuid}}@192.168.242.42"
        sshkey=""
        userdata=""

    - name: Make sure we get the IP we requested
      fail:
        msg: "We did not get the IP we requested: {{cirros_net_four_ip}} != 192.168.242.42"
      when: cirros_net_four_ip != "192.168.242.42"

    - name: Delete instance
      sf_instance:
        uuid: "{{cirros_net_four_uuid}}"
        state: absent

#########################################
# Scenario: try other ways to specify networks
#########################################

- hosts: sf-1
  any_errors_fatal: true
  become: yes
  become_method: sudo
  gather_facts: no
  connection: ssh

  tasks:
    - name: Try more detailed network specifications
      sf_instance:
        name: "cirros_netspec"
        cpu: 1
        ram: 1
        diskspecs:
          - size=8,base=cirros
        networkspecs:
          - network_uuid={{net_one_uuid}},address=192.168.242.66,macaddress=02:42:4d:0a:86:fe
        ssh_key: ""
        user_data: ""
        placement: "{{inventory_hostname}}"
      register: instance_create_out

    - name: Log instance details
      debug:
        msg: "{{instance_create_out}}"

    - name: Extract instance uuid
      set_fact:
        "cirros_netspec_uuid": "{{instance_create_out.meta.uuid}}"

    - name: Validate
      copy:
        content: |
          #!/bin/bash -e
          [ `grep -c "<mac address='02:42:4d:0a:86:fe'/>" /srv/shakenfist/instances/{{cirros_netspec_uuid}}/libvirt.xml` -eq 1 ]
          [ `grep -c "<source bridge='br-vxlan-" /srv/shakenfist/instances/{{cirros_netspec_uuid}}/libvirt.xml` -eq 1 ]
        dest: /tmp/shell_script
        owner: root
        group: root
        mode: u=rx,g=rx,o=rx

    - name: Execute
      shell: /tmp/shell_script

    - name: Delete instance
      sf_instance:
        uuid: "{{cirros_netspec_uuid}}"
        state: absent
